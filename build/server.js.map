{"version":3,"sources":["../src/server.js"],"names":["PORT","process","env","app","use","express","json","urlencoded","extended","db","Database","post","req","res","body","roomId","logUrl","init","insert","close","status","send","error","code","message","get","query","queryResult","httpServer","http","createServer","wsServer","Server","cors","origin","allowEIO3","rooms","phoneUsers","deviceUsers","on","socket","onAny","event","console","log","reason","SERVER_DISCONNECT","currentSocketId","id","isPhoneUser","find","phone","socketId","undefined","targetPhone","targetDevice","device","uniqueId","filter","isHost","room","emit","disconnectSockets","deviceSocket","sockets","leave","userList","e","errorMsg","push","callback","currentRoom","disconnect","title","username","language","join","to","phoneUser","removeIndex","findIndex","splice","fontSize_per","fontColor","targetRoom","mode","args","comment","time","targetId","reaction","handleListen","listen"],"mappings":"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","sourcesContent":["import http from \"http\";\nimport { Server } from \"socket.io\";\nimport express from \"express\";\n\nimport { Database } from \"./database\";\nimport { SERVER_DISCONNECT } from \"./constants\";\nimport {\n  emitErrorToSelf,\n  emitErrorToDevice,\n  emitErrorToAll,\n  generateRoomId,\n  getUserList,\n  getDeviceByUniqueId,\n} from \"./utils\";\n\nconst PORT = process.env.PORT || 4000;\n\nconst app = express();\napp.use(express.json());\napp.use(express.urlencoded({ extended: true }));\n\nconst db = new Database();\n\n// ログダウンロードURL送信\napp.post(\"/send-log-url\", async (req, res) => {\n  if (!req.body) {\n    return;\n  }\n\n  const { roomId, logUrl } = req.body;\n  try {\n    db.init();\n    db.insert(\"INSERT INTO log(roomId, logUrl) values(?, ?)\", [roomId, logUrl]);\n    db.close();\n\n    return res.status(201).send();\n  } catch (e) {\n    return res.status(500).send({\n      error: { code: 500, message: \"Fail to post data\" },\n    });\n  }\n});\n\n// ログダウンロードURL入手\napp.get(\"/get-log-url\", async (req, res) => {\n  const roomId = req.query.roomId;\n\n  try {\n    db.init();\n    const queryResult = await db.get(\"SELECT * FROM log WHERE roomId = ?\", [\n      roomId,\n    ]);\n    db.close();\n\n    return res.status(200).send({ logUrl: queryResult.logUrl });\n  } catch (e) {\n    return res.status(404).send({\n      error: { code: 404, message: \"Failed on getting data from database\" },\n    });\n  }\n});\n\nconst httpServer = http.createServer(app);\nconst wsServer = new Server(httpServer, {\n  cors: {\n    origin: \"*\",\n  },\n  // serveClient: false,\n  allowEIO3: true,\n});\n\nlet rooms = [];\nlet phoneUsers = [];\nlet deviceUsers = [];\n\nwsServer.on(\"connection\", (socket) => {\n  // イベント発火時のコンソール表示\n  socket.onAny((event) => {\n    console.log(`イベント: ${event}`);\n  });\n\n  // 接続切れの処理\n  socket.on(\"disconnect\", (reason) => {\n    if (reason !== SERVER_DISCONNECT) {\n      const currentSocketId = socket.id;\n\n      const isPhoneUser =\n        phoneUsers.find((phone) => phone.socketId === currentSocketId) !==\n        undefined\n          ? true\n          : false;\n\n      let targetPhone, targetDevice;\n      if (isPhoneUser) {\n        targetPhone = phoneUsers.find(\n          (phone) => phone.socketId === currentSocketId\n        );\n        targetDevice = deviceUsers.find(\n          (device) => device.uniqueId === targetPhone?.uniqueId\n        );\n      } else {\n        targetDevice = deviceUsers.find(\n          (device) => device.socketId === currentSocketId\n        );\n        targetPhone = phoneUsers.find(\n          (phone) => phone.uniqueId === targetDevice?.uniqueId\n        );\n      }\n\n      const roomId = targetPhone?.roomId;\n      const uniqueId = targetPhone?.uniqueId;\n\n      phoneUsers = phoneUsers.filter((phone) => phone.uniqueId !== uniqueId);\n      deviceUsers = deviceUsers.filter(\n        (device) => device.uniqueId !== uniqueId\n      );\n\n      if (targetPhone?.isHost) {\n        phoneUsers = [];\n        deviceUsers = [];\n        rooms = rooms.filter((room) => room.roomId !== roomId);\n\n        wsServer.emit(\"change-screen-leave\");\n\n        wsServer.emit(\"terminate-room-effect\");\n\n        wsServer.disconnectSockets();\n      } else {\n        try {\n          if (targetDevice !== undefined) {\n            const deviceSocket = wsServer.sockets.sockets.get(\n              targetDevice.socketId\n            );\n            deviceSocket.leave(roomId);\n            socket.leave(roomId);\n\n            wsServer.emit(\"leave-room-effect\", {\n              userList: getUserList(phoneUsers, roomId),\n            });\n          }\n        } catch (e) {\n          emitErrorToSelf(socket, { errorMsg: \"エラーが発生しました。\" });\n        }\n      }\n\n      console.log(\"rooms: \", rooms);\n      console.log(\"phoneUsers: \", phoneUsers);\n      console.log(\"deviceUsers: \", deviceUsers);\n    }\n  });\n\n  // 本体起動時にデバイス情報を登録\n  socket.on(\"entry\", ({ uniqueId }) => {\n    deviceUsers.push({\n      socketId: socket.id,\n      uniqueId,\n      roomId: \"\",\n    });\n  });\n\n  // ルーム情報取得\n  socket.on(\"get-room\", ({ roomId }, callback) => {\n    const currentRoom = rooms.find((room) => room.roomId === roomId);\n    if (!currentRoom) {\n      emitErrorToSelf(socket, { errorMsg: \"現在のルームを把握できません。\" });\n      socket.disconnect(true);\n      return;\n    }\n\n    callback({\n      title: currentRoom.title,\n      userList: getUserList(phoneUsers, roomId),\n    });\n  });\n\n  // ルーム作成\n  socket.on(\n    \"create-room\",\n    ({ title, username, uniqueId, language }, callback) => {\n      const roomId = generateRoomId(5);\n\n      rooms.push({\n        title: title,\n        username: username,\n        uniqueId: uniqueId,\n        language: language,\n        roomId: roomId,\n      });\n\n      phoneUsers.push({\n        socketId: socket.id,\n        uniqueId: uniqueId,\n        roomId: roomId,\n        username: username,\n        language: language,\n        isHost: true,\n      });\n\n      const targetDevice = getDeviceByUniqueId(deviceUsers, uniqueId);\n      if (targetDevice !== undefined) {\n        targetDevice.roomId = roomId;\n\n        const deviceSocket = wsServer.sockets.sockets.get(\n          targetDevice.socketId\n        );\n        deviceSocket.join(roomId);\n      }\n\n      socket.join(roomId);\n\n      callback({\n        roomId: roomId,\n      });\n\n      try {\n        wsServer.in(roomId).emit(\"join-room-effect\", {\n          userList: getUserList(phoneUsers, roomId),\n        });\n      } catch {\n        emitErrorToAll(wsServer, {\n          roomId,\n          errorMsg: \"エラーが発生しました。\",\n        });\n      }\n\n      try {\n        socket\n          .to(targetDevice.socketId)\n          .emit(\"change-screen-enter\", { roomId, username });\n      } catch {\n        emitErrorToSelf(socket, {\n          errorMsg: \"本体デバイスを検索できませんでした。\",\n        });\n        socket.disconnect(true);\n      }\n\n      console.log(\"rooms: \", rooms);\n      console.log(\"phoneUsers: \", phoneUsers);\n      console.log(\"deviceUsers: \", deviceUsers);\n    }\n  );\n\n  //ルーム参加処理\n  socket.on(\n    \"join-room\",\n    function ({ username, roomId, uniqueId, language }, callback) {\n      phoneUsers.push({\n        socketId: socket.id,\n        uniqueId: uniqueId,\n        roomId: roomId,\n        username: username,\n        language: language,\n        isHost: false,\n      });\n\n      const targetDevice = getDeviceByUniqueId(deviceUsers, uniqueId);\n      if (targetDevice !== undefined) {\n        targetDevice.roomId = roomId;\n\n        const deviceSocket = wsServer.sockets.sockets.get(\n          targetDevice.socketId\n        );\n        deviceSocket.join(roomId);\n      }\n\n      socket.join(roomId);\n\n      // FIXME: コールバックしないといけないかフロントのコードに合わせて削除してもいいと思う。\n      callback({\n        userList: getUserList(phoneUsers, roomId),\n      });\n\n      try {\n        wsServer.emit(\"join-room-effect\", {\n          userList: getUserList(phoneUsers, roomId),\n        });\n      } catch (e) {\n        emitErrorToAll(wsServer, {\n          roomId,\n          errorMsg: \"エラーが発生しました。\",\n        });\n      }\n\n      try {\n        socket\n          .to(targetDevice.socketId)\n          .emit(\"change-screen-enter\", { roomId, username });\n      } catch (e) {\n        emitErrorToSelf(socket, {\n          errorMsg: \"本体デバイスを検索できませんでした。\",\n        });\n        socket.disconnect(true);\n      }\n\n      console.log(\"rooms: \", rooms);\n      console.log(\"phoneUsers: \", phoneUsers);\n      console.log(\"deviceUsers: \", deviceUsers);\n    }\n  );\n\n  // ルーム退出\n  socket.on(\"leave-room\", ({ uniqueId }) => {\n    const targetDevice = getDeviceByUniqueId(deviceUsers, uniqueId);\n\n    const phoneUser = phoneUsers.find((phone) => phone.uniqueId === uniqueId);\n\n    if (phoneUser.isHost) {\n      phoneUsers = [];\n      deviceUsers = [];\n      rooms = rooms.filter((room) => room.roomId !== phoneUser.roomId);\n\n      wsServer.emit(\"change-screen-leave\");\n\n      wsServer.emit(\"terminate-room-effect\");\n\n      wsServer.disconnectSockets();\n    } else {\n      const removeIndex = phoneUsers.findIndex(\n        (phone) => phone.uniqueId === uniqueId\n      );\n      phoneUsers.splice(removeIndex, 1);\n\n      deviceUsers = deviceUsers.filter(\n        (device) => device.uniqueId !== uniqueId\n      );\n\n      try {\n        socket.to(targetDevice.socketId).emit(\"change-screen-leave\");\n      } catch (e) {\n        emitErrorToSelf(socket, { errorMsg: \"エラーが発生しました。\" });\n        socket.disconnect(true);\n      }\n\n      try {\n        wsServer.emit(\"leave-room-effect\", {\n          userList: getUserList(phoneUsers, phoneUser.roomId),\n        });\n\n        if (targetDevice !== undefined) {\n          const deviceSocket = wsServer.sockets.sockets.get(\n            targetDevice.socketId\n          );\n          deviceSocket.leave(phoneUser.roomId);\n        }\n\n        socket.leave(phoneUser.roomId);\n      } catch (e) {\n        emitErrorToAll(wsServer, {\n          roomId: phoneUser.roomId,\n          errorMsg: \"エラーが発生しました。\",\n        });\n      }\n    }\n    console.log(\"rooms: \", rooms);\n    console.log(\"phoneUsers: \", phoneUsers);\n    console.log(\"deviceUsers: \", deviceUsers);\n  });\n\n  // ルーム解散\n  socket.on(\"terminate-room\", ({ roomId }) => {\n    phoneUsers = phoneUsers.filter((phone) => phone.roomId !== roomId);\n    deviceUsers = deviceUsers.filter((device) => device.roomId !== roomId);\n    rooms = rooms.filter((room) => room.roomId !== roomId);\n\n    try {\n      wsServer.emit(\"terminate-room-effect\");\n\n      wsServer.emit(\"change-screen-leave\");\n\n      wsServer.disconnectSockets(roomId);\n    } catch (e) {\n      emitErrorToAll(wsServer, {\n        roomId,\n        errorMsg: \"エラーが発生しました。\",\n      });\n      socket.disconnect(true);\n    }\n\n    console.log(\"rooms: \", rooms);\n    console.log(\"phoneUsers: \", phoneUsers);\n    console.log(\"deviceUsers: \", deviceUsers);\n  });\n\n  // アクセシビリティ更新\n  socket.on(\"change-accessibility\", ({ fontSize_per, fontColor, uniqueId }) => {\n    const targetDevice = getDeviceByUniqueId(deviceUsers, uniqueId);\n\n    if (targetDevice !== undefined) {\n      try {\n        socket\n          .to(targetDevice.socketId)\n          .emit(\"change-accessibility-effect\", { fontSize_per, fontColor });\n      } catch (error) {\n        emitErrorToSelf(socket, {\n          errorMsg: \"アクセシビリティ変更にエラーが発生しました。\",\n        });\n      }\n    }\n  });\n\n  // 議題変更\n  socket.on(\"updated-title\", ({ roomId, title }) => {\n    const targetRoom = rooms.find((room) => room.roomId === roomId);\n\n    if (targetRoom !== undefined) {\n      try {\n        wsServer.in(targetRoom.roomId).emit(\"updated-title-effect\", { title });\n      } catch (error) {\n        emitErrorToAll(wsServer, {\n          roomId: targetRoom.roomId,\n          errorMsg: \"タイトル更新にエラーが発生しました。\",\n        });\n      }\n    }\n  });\n\n  // モード切替\n  socket.on(\"change-mode\", ({ uniqueId, mode }) => {\n    const targetDevice = getDeviceByUniqueId(deviceUsers, uniqueId);\n\n    if (targetDevice !== undefined) {\n      try {\n        socket.to(targetDevice.socketId).emit(\"change-mode-effect\", { mode });\n      } catch (error) {\n        emitErrorToSelf(socket, { errorMsg: \"エラーが発生しました。\" });\n      }\n    }\n  });\n\n  // 音声検知\n  socket.on(\"send-detected-voice\", (args) => {\n    const targetDevice = getDeviceByUniqueId(deviceUsers, args.uniqueId);\n\n    try {\n      wsServer.emit(\"emit-log\", {\n        username: targetDevice.username,\n        comment: args.comment,\n        time: args.time,\n      });\n    } catch (e) {\n      emitErrorToDevice(socket, {\n        targetId: targetDevice.socketId,\n        errorMsg: \"エラーが発生しました。\",\n      });\n    }\n  });\n\n  // ジェスチャー検知\n  socket.on(\"send-detected-gesture\", (args) => {\n    const targetDevice = getDeviceByUniqueId(deviceUsers, args.uniqueId);\n\n    try {\n      wsServer.emit(\"emit-reaction\", {\n        username: targetDevice.username,\n        reaction: args.reaction,\n        time: args.time,\n      });\n    } catch (e) {\n      emitErrorToDevice(socket, {\n        targetId: targetDevice.socketId,\n        errorMsg: \"エラーが発生しました。\",\n      });\n    }\n  });\n});\n\nconst handleListen = () => console.log(`Listening on http://localhost:${PORT}`);\n\nhttpServer.listen(PORT, \"0.0.0.0\", handleListen);\n"],"file":"server.js"}