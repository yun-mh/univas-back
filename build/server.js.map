{"version":3,"sources":["../src/server.js"],"names":["PORT","process","env","app","use","express","json","urlencoded","extended","db","Database","post","req","res","body","roomId","logUrl","init","insert","close","status","send","error","code","message","get","query","queryResult","httpServer","http","createServer","wsServer","Server","cors","origin","allowEIO3","rooms","phoneUsers","deviceUsers","on","socket","onAny","event","console","log","reason","SERVER_DISCONNECT","currentSocketId","id","isPhoneUser","find","phone","socketId","undefined","targetPhone","targetDevice","device","ipaddress","filter","isHost","room","emit","disconnectSockets","deviceSocket","sockets","leave","userList","e","errorMsg","request","remoteAddress","handshake","address","client","conn","push","callback","currentRoom","disconnect","title","username","language","join","to","phoneUser","removeIndex","findIndex","splice","fontSize_per","fontColor","targetRoom","mode","args","comment","time","targetId","reaction","handleListen","listen"],"mappings":"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","sourcesContent":["import http from \"http\";\nimport { Server } from \"socket.io\";\nimport express from \"express\";\n\nimport { Database } from \"./database\";\nimport { SERVER_DISCONNECT } from \"./constants\";\nimport {\n  emitErrorToSelf,\n  emitErrorToDevice,\n  emitErrorToAll,\n  generateRoomId,\n  getUserList,\n  getDeviceByIPAddress,\n} from \"./utils\";\n\nconst PORT = process.env.PORT || 4000;\n\nconst app = express();\napp.use(express.json());\napp.use(express.urlencoded({ extended: true }));\n\nconst db = new Database();\n\n// ログダウンロードURL送信\napp.post(\"/send-log-url\", async (req, res) => {\n  if (!req.body) {\n    return;\n  }\n\n  const { roomId, logUrl } = req.body;\n  try {\n    db.init();\n    db.insert(\"INSERT INTO log(roomId, logUrl) values(?, ?)\", [roomId, logUrl]);\n    db.close();\n\n    return res.status(201).send();\n  } catch (e) {\n    return res.status(500).send({\n      error: { code: 500, message: \"Fail to post data\" },\n    });\n  }\n});\n\n// ログダウンロードURL入手\napp.get(\"/get-log-url\", async (req, res) => {\n  const roomId = req.query.roomId;\n\n  try {\n    db.init();\n    const queryResult = await db.get(\"SELECT * FROM log WHERE roomId = ?\", [\n      roomId,\n    ]);\n    db.close();\n\n    return res.status(200).send({ logUrl: queryResult.logUrl });\n  } catch (e) {\n    return res.status(404).send({\n      error: { code: 404, message: \"Failed on getting data from database\" },\n    });\n  }\n});\n\nconst httpServer = http.createServer(app);\nconst wsServer = new Server(httpServer, {\n  cors: {\n    origin: \"*\",\n  },\n  // serveClient: false,\n  allowEIO3: true,\n});\n\nlet rooms = [];\nlet phoneUsers = [];\nlet deviceUsers = [];\n\nwsServer.on(\"connection\", (socket) => {\n  // イベント発火時のコンソール表示\n  socket.onAny((event) => {\n    console.log(`イベント: ${event}`);\n  });\n\n  // 接続切れの処理\n  socket.on(\"disconnect\", (reason) => {\n    if (reason !== SERVER_DISCONNECT) {\n      const currentSocketId = socket.id;\n\n      const isPhoneUser =\n        phoneUsers.find((phone) => phone.socketId === currentSocketId) !==\n        undefined\n          ? true\n          : false;\n\n      let targetPhone, targetDevice;\n      if (isPhoneUser) {\n        targetPhone = phoneUsers.find(\n          (phone) => phone.socketId === currentSocketId\n        );\n        targetDevice = deviceUsers.find(\n          (device) => device.ipaddress === targetPhone?.ipaddress\n        );\n      } else {\n        targetDevice = deviceUsers.find(\n          (device) => device.socketId === currentSocketId\n        );\n        targetPhone = phoneUsers.find(\n          (phone) => phone.ipaddress === targetDevice?.ipaddress\n        );\n      }\n\n      const roomId = targetPhone?.roomId;\n      const ipaddress = targetPhone?.ipaddress;\n\n      phoneUsers = phoneUsers.filter((phone) => phone.ipaddress !== ipaddress);\n      deviceUsers = deviceUsers.filter(\n        (device) => device.ipaddress !== ipaddress\n      );\n\n      if (targetPhone?.isHost) {\n        phoneUsers = [];\n        deviceUsers = [];\n        rooms = rooms.filter((room) => room.roomId !== roomId);\n\n        wsServer.emit(\"change-screen-leave\");\n\n        wsServer.emit(\"terminate-room-effect\");\n\n        wsServer.disconnectSockets();\n      } else {\n        try {\n          if (targetDevice !== undefined) {\n            const deviceSocket = wsServer.sockets.sockets.get(\n              targetDevice.socketId\n            );\n            deviceSocket.leave(roomId);\n            socket.leave(roomId);\n\n            wsServer.emit(\"leave-room-effect\", {\n              userList: getUserList(phoneUsers, roomId),\n            });\n          }\n        } catch (e) {\n          emitErrorToSelf(socket, { errorMsg: \"エラーが発生しました。\" });\n        }\n      }\n\n      console.log(\"rooms: \", rooms);\n      console.log(\"phoneUsers: \", phoneUsers);\n      console.log(\"deviceUsers: \", deviceUsers);\n    }\n  });\n\n  // 本体起動時にデバイス情報を登録\n  socket.on(\"entry\", () => {\n    console.log(\"request remoteAddress: \", socket.request.socket.remoteAddress);\n    console.log(\"handshake: \", socket.handshake.address);\n    console.log(\n      \"client conn remoteAddress: \",\n      socket.client.conn.remoteAddress\n    );\n    deviceUsers.push({\n      socketId: socket.id,\n      ipaddress: socket.client.conn.remoteAddress,\n      roomId: \"\",\n    });\n  });\n\n  // ルーム情報取得\n  socket.on(\"get-room\", ({ roomId }, callback) => {\n    const currentRoom = rooms.find((room) => room.roomId === roomId);\n    if (!currentRoom) {\n      emitErrorToSelf(socket, { errorMsg: \"現在のルームを把握できません。\" });\n      socket.disconnect(true);\n      return;\n    }\n\n    callback({\n      title: currentRoom.title,\n      userList: getUserList(phoneUsers, roomId),\n    });\n  });\n\n  // ルーム作成\n  socket.on(\n    \"create-room\",\n    ({ title, username, ipaddress, language }, callback) => {\n      const roomId = generateRoomId(5);\n\n      rooms.push({\n        title: title,\n        username: username,\n        ipaddress: ipaddress,\n        language: language,\n        roomId: roomId,\n      });\n\n      phoneUsers.push({\n        socketId: socket.id,\n        ipaddress: ipaddress,\n        roomId: roomId,\n        username: username,\n        language: language,\n        isHost: true,\n      });\n\n      const targetDevice = getDeviceByIPAddress(deviceUsers, ipaddress);\n      if (targetDevice !== undefined) {\n        targetDevice.roomId = roomId;\n\n        const deviceSocket = wsServer.sockets.sockets.get(\n          targetDevice.socketId\n        );\n        deviceSocket.join(roomId);\n      }\n\n      socket.join(roomId);\n\n      callback({\n        roomId: roomId,\n      });\n\n      try {\n        wsServer.in(roomId).emit(\"join-room-effect\", {\n          userList: getUserList(phoneUsers, roomId),\n        });\n      } catch {\n        emitErrorToAll(wsServer, {\n          roomId,\n          errorMsg: \"エラーが発生しました。\",\n        });\n      }\n\n      try {\n        socket\n          .to(targetDevice.socketId)\n          .emit(\"change-screen-enter\", { roomId, username });\n      } catch {\n        emitErrorToSelf(socket, {\n          errorMsg: \"本体デバイスを検索できませんでした。\",\n        });\n        socket.disconnect(true);\n      }\n\n      console.log(\"rooms: \", rooms);\n      console.log(\"phoneUsers: \", phoneUsers);\n      console.log(\"deviceUsers: \", deviceUsers);\n    }\n  );\n\n  //ルーム参加処理\n  socket.on(\n    \"join-room\",\n    function ({ username, roomId, ipaddress, language }, callback) {\n      phoneUsers.push({\n        socketId: socket.id,\n        ipaddress: ipaddress,\n        roomId: roomId,\n        username: username,\n        language: language,\n        isHost: false,\n      });\n\n      const targetDevice = getDeviceByIPAddress(deviceUsers, ipaddress);\n      if (targetDevice !== undefined) {\n        targetDevice.roomId = roomId;\n\n        const deviceSocket = wsServer.sockets.sockets.get(\n          targetDevice.socketId\n        );\n        deviceSocket.join(roomId);\n      }\n\n      socket.join(roomId);\n\n      // FIXME: コールバックしないといけないかフロントのコードに合わせて削除してもいいと思う。\n      callback({\n        userList: getUserList(phoneUsers, roomId),\n      });\n\n      try {\n        wsServer.emit(\"join-room-effect\", {\n          userList: getUserList(phoneUsers, roomId),\n        });\n      } catch (e) {\n        emitErrorToAll(wsServer, {\n          roomId,\n          errorMsg: \"エラーが発生しました。\",\n        });\n      }\n\n      try {\n        socket\n          .to(targetDevice.socketId)\n          .emit(\"change-screen-enter\", { roomId, username });\n      } catch (e) {\n        emitErrorToSelf(socket, {\n          errorMsg: \"本体デバイスを検索できませんでした。\",\n        });\n        socket.disconnect(true);\n      }\n\n      console.log(\"rooms: \", rooms);\n      console.log(\"phoneUsers: \", phoneUsers);\n      console.log(\"deviceUsers: \", deviceUsers);\n    }\n  );\n\n  // ルーム退出\n  socket.on(\"leave-room\", ({ ipaddress }) => {\n    const targetDevice = getDeviceByIPAddress(deviceUsers, ipaddress);\n\n    const phoneUser = phoneUsers.find((phone) => phone.ipaddress === ipaddress);\n\n    if (phoneUser.isHost) {\n      phoneUsers = [];\n      deviceUsers = [];\n      rooms = rooms.filter((room) => room.roomId !== phoneUser.roomId);\n\n      wsServer.emit(\"change-screen-leave\");\n\n      wsServer.emit(\"terminate-room-effect\");\n\n      wsServer.disconnectSockets();\n    } else {\n      const removeIndex = phoneUsers.findIndex(\n        (phone) => phone.ipaddress === ipaddress\n      );\n      phoneUsers.splice(removeIndex, 1);\n\n      deviceUsers = deviceUsers.filter(\n        (device) => device.ipaddress !== ipaddress\n      );\n\n      try {\n        socket.to(targetDevice.socketId).emit(\"change-screen-leave\");\n      } catch (e) {\n        emitErrorToSelf(socket, { errorMsg: \"エラーが発生しました。\" });\n        socket.disconnect(true);\n      }\n\n      try {\n        wsServer.emit(\"leave-room-effect\", {\n          userList: getUserList(phoneUsers, phoneUser.roomId),\n        });\n\n        if (targetDevice !== undefined) {\n          const deviceSocket = wsServer.sockets.sockets.get(\n            targetDevice.socketId\n          );\n          deviceSocket.leave(phoneUser.roomId);\n        }\n\n        socket.leave(phoneUser.roomId);\n      } catch (e) {\n        emitErrorToAll(wsServer, {\n          roomId: phoneUser.roomId,\n          errorMsg: \"エラーが発生しました。\",\n        });\n      }\n    }\n    console.log(\"rooms: \", rooms);\n    console.log(\"phoneUsers: \", phoneUsers);\n    console.log(\"deviceUsers: \", deviceUsers);\n  });\n\n  // ルーム解散\n  socket.on(\"terminate-room\", ({ roomId }) => {\n    phoneUsers = phoneUsers.filter((phone) => phone.roomId !== roomId);\n    deviceUsers = deviceUsers.filter((device) => device.roomId !== roomId);\n    rooms = rooms.filter((room) => room.roomId !== roomId);\n\n    try {\n      wsServer.emit(\"terminate-room-effect\");\n\n      wsServer.emit(\"change-screen-leave\");\n\n      wsServer.disconnectSockets(roomId);\n    } catch (e) {\n      emitErrorToAll(wsServer, {\n        roomId,\n        errorMsg: \"エラーが発生しました。\",\n      });\n      socket.disconnect(true);\n    }\n\n    console.log(\"rooms: \", rooms);\n    console.log(\"phoneUsers: \", phoneUsers);\n    console.log(\"deviceUsers: \", deviceUsers);\n  });\n\n  // アクセシビリティ更新\n  socket.on(\n    \"change-accessibility\",\n    ({ fontSize_per, fontColor, ipaddress }) => {\n      const targetDevice = getDeviceByIPAddress(deviceUsers, ipaddress);\n\n      if (targetDevice !== undefined) {\n        try {\n          socket\n            .to(targetDevice.socketId)\n            .emit(\"change-accessibility-effect\", { fontSize_per, fontColor });\n        } catch (error) {\n          emitErrorToSelf(socket, {\n            errorMsg: \"アクセシビリティ変更にエラーが発生しました。\",\n          });\n        }\n      }\n    }\n  );\n\n  // 議題変更\n  socket.on(\"updated-title\", ({ roomId, title }) => {\n    const targetRoom = rooms.find((room) => room.roomId === roomId);\n\n    if (targetRoom !== undefined) {\n      try {\n        wsServer.in(targetRoom.roomId).emit(\"updated-title-effect\", { title });\n      } catch (error) {\n        emitErrorToAll(wsServer, {\n          roomId: targetRoom.roomId,\n          errorMsg: \"タイトル更新にエラーが発生しました。\",\n        });\n      }\n    }\n  });\n\n  // モード切替\n  socket.on(\"change-mode\", ({ ipaddress, mode }) => {\n    const targetDevice = getDeviceByIPAddress(deviceUsers, ipaddress);\n\n    if (targetDevice !== undefined) {\n      try {\n        socket.to(targetDevice.socketId).emit(\"change-mode-effect\", { mode });\n      } catch (error) {\n        emitErrorToSelf(socket, { errorMsg: \"エラーが発生しました。\" });\n      }\n    }\n  });\n\n  //AI用\n  socket.on(\"send-detected-voice\", (args) => {\n    const targetDevice = getDeviceByIPAddress(\n      deviceUsers,\n      socket.client.conn.remoteAddress\n    );\n\n    try {\n      wsServer.emit(\"emit-log\", {\n        username: targetDevice.username,\n        comment: args.comment,\n        time: args.time,\n      });\n    } catch (e) {\n      emitErrorToDevice(socket, {\n        targetId: targetDevice.socketId,\n        errorMsg: \"エラーが発生しました。\",\n      });\n    }\n  });\n\n  socket.on(\"send-detected-gesture\", (args) => {\n    const targetDevice = getDeviceByIPAddress(\n      deviceUsers,\n      socket.client.conn.remoteAddress\n    );\n\n    try {\n      wsServer.emit(\"emit-reaction\", {\n        username: targetDevice.username,\n        reaction: args.reaction,\n        time: args.time,\n      });\n    } catch (e) {\n      emitErrorToDevice(socket, {\n        targetId: targetDevice.socketId,\n        errorMsg: \"エラーが発生しました。\",\n      });\n    }\n  });\n});\n\nconst handleListen = () => console.log(`Listening on http://localhost:${PORT}`);\n\nhttpServer.listen(PORT, \"0.0.0.0\", handleListen);\n\n//本体クライアントのブラウザ起動\n// const { PythonShell } = require(\"python-shell\");\n// PythonShell.run(\"python_scripts/browserRun.py\", null, (err, result) => {\n//   if (err) {\n//     console.log(err);\n//   } else {\n//     console.log(result);\n//   }\n// });\n"],"file":"server.js"}